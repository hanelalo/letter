---
title: Elasticsearch:简介
date: 2023-06-04 10:24:17
tags: 
  - Elasticsearch
  - 中间件
categories: Elasticsearch
---

# Elasticsearch 简介

Elasticsearch 是一个分布式的文档存储系统。内部将文档序列化成 JSON 格式进行存储，如果集群中有多个节点，一旦数据被存储，可以从任何一个节点上访问到本存储的数据。

但是，因为一些内部机制的实现，所以 Elasticsearch 的搜索功能是一个**近实时**的功能，一般在 1 秒内。换句话讲，当数据写到 Elasticsearch 后，可能在 1 秒内还无法查询到。

> 关于近实时的原因，本系列后续的文章会讲到。

> 在本系列的内容中，`es`、`ES` 在无特殊说明情况下，均指 Elasticsearch。

## 文档、索引

在 es 中，一条数据可以理解成 MySQL 中的一条数据，每条数据中又包含了很多字段，每个字段有自己的数据类型。

索引，有两种含义。当用作名词的时候，指的是相同类型的文档的集合，就相当于是 MySQL 中的表；当用作动词时，指的是将文档写入 es，这个过程 es 会建立倒排索引。

在MySQL 中每个字段都需要指定数据类型，而 es 中则可以选择不指定，而是让 es 自己进行探测，来决定每个字段是什么类型，但是，相同字段在不同文档中，不能是不同的类型。而对于字段类型，也可以自行指定，比如时间的存储格式。这就是每个索引创建时，可以指定的 mappings。

es 存储文档的时候，不同的字段类型，存储的方式也可能不同，比如 text 类型的字段存储在倒排索引中，而 number、geo 类型则是存储在 BKD 树中。

> 倒排索引：记录每个单词（es 内部会对字段值做分词）出现过的文档列表。
>
> BKD 树：说实话，网上找了好几篇文章看，都没看懂原理，大概意思是，能够支持动态数据的多维度搜索，比如像二叉树，其实是一维的搜索，为了支持多维搜索，衍生了 KD 树，但是 KD 树作为树不能自平衡，导致搜索效率低，浪费资源，又整合 B 树，衍生了 KDB 树，但是哪怕发展到了 KDB 树，也依然只支持静态数据的搜索，所以又整合 B+ 树，取二叉树、B 树、B+ 树、KD 树的优点，最后才发展成了 BKD 树，支持动态数据的多维度搜索。
>
> 这里的 D 是 Dimensional 的意思，比如平时说的 3D 的 D 大致就是这个词。
>
> es 并不是在诞生支持就支持了 BKD 树，Lucene 也是在 6.0 才开始支持 BKD 树。

## 数据查询

基于存储时对不同数据类型的存储优化，es 不仅支持类似 MySQL 的针对特定字段的查询，还支持了全文检索。

es 提供了简单易用的 Restful 风格的 api，但并不是只有查询的 api，读写的 api 都有，还有一些集群状态和工具类型的 api 也可以使用。可以直接在命令行中对 api 发起请求，或者通过 Kibana 发起请求。

es 的 api 支持结构化检索、全文检索，以及将两者结合在一起的复杂查询。结构化检索可以类比成 MySQL 中的 sql 语句的查询，全文检索则是会检索所有和查询字符串相匹配的文档，并按照文档和检索内容的相关性进行排序返回。

除了这些，es 还支持短语搜索，比如英文里面的 `from..to..` 这种短语的搜索，还支持模糊查询、前缀查询。

对于查询的操作，es 提供了一套完整的 JSON 格式的 DSL 进行查询，甚至还可以直接通过 sql 进行查询。

## 扩展性、伸缩性

es 天生支持分布式存储数据，可以根据需要进行扩展，当往集群中增加 node 时，es 会自动迁移数据到新的节点，让新的节点也分担集群的压力，并且这个过程，不需要重启应用。

es 中的索引，是一个多对个逻辑分片组成。文档分布在索引的分片中，而分片有分布在不同的节点上，这不仅降低了硬件损坏带来的影响，而且还能通过往集群中增加新的节点来扩大集群的查询容量。当集群增加或减少节点时，es 都会自动的迁移索引的分片，以平衡集群的负载情况。

es 中的分片，有主分片和副本分片两种。索引中的每个分档都属于某一个主分片，而每个主分片可以有多个副本分片，副本分片一般都和主分片在不同的节点上，这样能进一步防止硬件故障对集群造成影响，并且还能提升集群的查询性能。

es 中每个索引的主分片数，是在索引创建时就已经确定且再也不能更改的，而副本分片的数量则是随时更改的，并且不会中断读写。

### 索引的大小、性能

分片数量和分片大小，和索引的性能息息相关。分片数量越多，维护这些分片的消耗就越大，而单个分片越大，当 es 集群节点变更需要迁移分片时，所耗费的时间就越多。

查询大量的小分片，每个分片上的查询速度是比较快的，但分片越多，消耗的资源就越多，因为查询的次数变多了，所以有时候查询少量的大分片可能会更快，所以这个并没有固定是分片越多越好还是越少越好，需要按实际情况进行评估。

不过官方的建议有 2 个点：

1. 分片的平均大小建议在几个 G 到几十个 G 之间，对于一些时间序列的数据，通常在 20 到 40 GB。
2. 要避免大分片，每个节点上的分片数量和堆内存成正比，通常每 GB 的分片数量不超过 20 个。

> 虽然是建议，但是通常还是应该比建议的标准还要严格些，不要非得节点上挤满了 20 个分片才进行集群扩容。

### 跨集群复制

为了保证集群的节点自检有良好稳定的连接，通常会将集群的节点部署在同一个机房。但是，如果集群故障，那么相关的业务将会不可用，所以 es 提供了 CCR（Cross-cluster Replication，跨集群复制）。

CCR 能够自动同步主机群的索引数据到热备集群，如果主机群故障，热备的集群可以立马接管线上业务。

主集群可以进行读写操作，而备集群只能进行读操作。

## 参考文档

* [BKD trees, used in Elasticsearch](https://medium.com/swlh/bkd-trees-used-in-elasticsearch-40e8afd2a1a4)
* [K-D tree, K-D-B tree, B-K-D tree](https://www.programmersought.com/article/92224903019/)
